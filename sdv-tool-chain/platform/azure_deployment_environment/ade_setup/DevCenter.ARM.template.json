{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "userPrincipalId": {
            "type": "string",
            "metadata": {
                "description": "The user to be assigned an admin role for the dev center. Use your Principal ID."
            }
        },
        "devCenterName": {
            "type": "string",
            "metadata": {
                "description": "The name of the dev center. Must be unique within the tenant."
            }
        },
        "devCenterProjectName": {
            "type": "string",
            "metadata": {
                "description": "The name of the dev center project. Must be unique within the resource group."
            }
        }
    },
    "variables": {
        "devCenterProjectAdministratorRoleId": "331c37c6-af14-46d9-b9f4-e1909e1b95a0",
        "devEnvironmentName": "Dev",
        "testEnvironmentName": "Test",
        "contributorRoleId": "b24988ac-6180-42a0-ab88-20f7382dd24c"
    },
    "resources": [
        {
            "type": "Microsoft.DevCenter/devcenters",
            "apiVersion": "2023-04-01",
            "name": "[parameters('devCenterName')]",
            "location": "[resourceGroup().location]",
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {}
        },
        {
            "type": "Microsoft.DevCenter/devcenters/environmentTypes",
            "apiVersion": "2023-04-01",
            "name": "[concat(parameters('devCenterName'), '/', variables('devEnvironmentName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.DevCenter/devcenters', parameters('devCenterName'))]"
            ],
            "properties": {}
        },
        {
            "type": "Microsoft.DevCenter/devcenters/environmentTypes",
            "apiVersion": "2023-04-01",
            "name": "[concat(parameters('devCenterName'), '/', variables('testEnvironmentName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.DevCenter/devcenters', parameters('devCenterName'))]"
            ],
            "properties": {}
        },
        {
            "type": "Microsoft.DevCenter/projects",
            "apiVersion": "2023-04-01",
            "name": "[parameters('devCenterProjectName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "devCenterId": "[concat(resourceGroup().id, '/providers/', reference(parameters('devCenterName'), '2023-04-01', 'Full').resourceId)]"
            }
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2022-04-01",
            "name": "[guid(concat(parameters('devCenterName'), parameters('userPrincipalId'), 'DevCenterProjectAdminRole'))]",
            "scope": "[resourceId('Microsoft.DevCenter/projects', parameters('devCenterProjectName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.DevCenter/projects', parameters('devCenterProjectName'))]"
            ],
            "properties": {
                "roleDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/roleDefinitions/', variables('devCenterProjectAdministratorRoleId'))]",
                "principalId": "[parameters('userPrincipalId')]"
            }
        },
        {
            "type": "Microsoft.DevCenter/projects/environmentTypes",
            "apiVersion": "2023-04-01",
            "name": "[concat(parameters('devCenterProjectName'), '/', variables('devEnvironmentName'))]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.DevCenter/projects', parameters('devCenterProjectName'))]",
                "[resourceId('Microsoft.DevCenter/devcenters/environmentTypes', parameters('devCenterName'), variables('devEnvironmentName'))]"
            ],
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "creatorRoleAssignment": {
                    "roles": {
                        "[variables('contributorRoleId')]": {}
                    }
                },
                "status": "Enabled",
                "deploymentTargetId": "[subscription().id]"
            }
        },
        {
            "type": "Microsoft.DevCenter/projects/environmentTypes",
            "apiVersion": "2023-04-01",
            "name": "[concat(parameters('devCenterProjectName'), '/', variables('testEnvironmentName'))]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.DevCenter/projects', parameters('devCenterProjectName'))]",
                "[resourceId('Microsoft.DevCenter/devcenters/environmentTypes', parameters('devCenterName'), variables('testEnvironmentName'))]"
            ],
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "creatorRoleAssignment": {
                    "roles": {
                        "[variables('contributorRoleId')]": {}
                    }
                },
                "status": "Enabled",
                "deploymentTargetId": "[subscription().id]"
            }
        }
    ]
}
