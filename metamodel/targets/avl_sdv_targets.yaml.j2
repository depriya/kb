# Copyright (C) Microsoft Corporation.

azure_login:
  description: Login to Azure using a system-assigned managed identity
  type: azure login

avl_devops_custom_script:
  description: Execute the AVL DevOps custom script
  type: avl devops custom extension run script with parameters
  depends_on:
    - azure_login
  parameters:
    input_parameter: {{ config }}

avl_devops_custom_powershell_script:
  description: Execute the AVL DevOps custom powershell script in bash
  type: avl devops custom extension run pwsh script in bash
  depends_on:
    - azure_login
  parameters:
    input_parameter: {{ config }}

deploy_avl_symphony_campaign_build:
  description: The Symphony campaign to execute the AVL DevOps scripts till Build completion
  type: symphony campaign
  depends_on:
    - azure_login
    - avl_devops_custom_script
    - avl_devops_custom_powershell_script
  parameters:
    campaign_name: build_{{ config.project_config.project_name }}_{{ config.workflow_run_config.job_id }}
    campaign_activation_name: build_{{ config.project_config.project_name }}_{{ config.workflow_run_config.job_id }}_activation
    campaign_start_stage_inputs:

    campaign_file_name: deploy_avl_devops_symphony_campaign_build

    symphony_campaign_parameters_file: ./targets/deploy_avl_devops_symphony_campaign_build.json.j2
    symphony_campaign_parameters_file_input:
      # Empty stage will use the default stage as defined in symphony-campaign.json
      campaign_start_stage:
      toolchain_output_path: "{{ config.symphony.toolchain_output_path }}/{{ config.resource_name_primary_prefix }}{{ config.resource_name_secondary_prefix }}s{{ config.project_config.environment_stage[0] }}st/{{ config.project_config.oem_identifier }}/{{ config.project_config.project_name }}"
    symphony_base_url: {{ config.symphony.base_url }}

deploy_avl_symphony_campaign_execute:
  description: The Symphony campaign to execute the AVL DevOps scripts from end of Build till Execution completion
  type: symphony campaign
  depends_on:
    - azure_login
    - avl_devops_custom_script
    - avl_devops_custom_powershell_script
    - deploy_avl_symphony_campaign_build
  parameters:
    campaign_name: execute_{{ config.project_config.project_name }}_{{ config.workflow_run_config.job_id }}
    campaign_activation_name: execute_{{ config.project_config.project_name }}_{{ config.workflow_run_config.job_id }}_activation
    campaign_start_stage_inputs:

    campaign_file_name: deploy_avl_devops_symphony_campaign_execute

    symphony_campaign_parameters_file: ./targets/deploy_avl_devops_symphony_campaign_execute.json.j2
    symphony_campaign_parameters_file_input:
      # Empty stage will use the default stage as defined in symphony-campaign.json
      campaign_start_stage:
      toolchain_output_path: "{{ config.symphony.toolchain_output_path }}/{{ config.resource_name_primary_prefix }}{{ config.resource_name_secondary_prefix }}s{{ config.project_config.environment_stage[0] }}st/{{ config.project_config.oem_identifier }}/{{ config.project_config.project_name }}"
    symphony_base_url: {{ config.symphony.base_url }}
