#!/bin/bash

# Copyright (C) Microsoft Corporation.

# Exit immediately if a command fails
set -e

# Fail if an unset variable is used
set -u

source $(dirname $0)/symphony_stage_script_provider.sh

#region declare command variables & functions
command=""
_command_output=""
_command_status=0

function clear_command_variables() {
    command=""
    _command_output=""
    _command_status=0
}
#endregion declare command variables & functions

#region Declare Constants
resource_name_customer_short="c"
OEM_Subnet="OEMSubnet" #TODO: Discuss. Should this come from the config? - Derive from naming convention
#endregion Declare Constants

#region Getting config from metamodel config yaml
configEncoded="{{ parameters.input_parameter_to_script }}"
config=$(echo $configEncoded | base64 -d)
#endregion Getting config from metamodel config yaml

#region parameters - get from config
resource_name_primary_prefix=$(echo $config | jq -r '.resource_name_primary_prefix')
resource_name_secondary_prefix=$(echo $config | jq -r '.resource_name_secondary_prefix')
customer_OEM_suffix=$(echo $config | jq -r '.project_config.oem_identifier')
project_name=$(echo $config | jq -r '.project_config.project_name')
environment_stage_short=$(echo $config | jq -r '.project_config.environment_stage' | cut -c1)
subscription_id=$(echo $config | jq -r '.customer_stamp_config.target_subscription_id')
LOCATION=$(echo $config | jq -r '.customer_stamp_config.azure_region')

IMAGE=$(echo $config | jq -r '.customer_stamp_config.devbox_image_definition_name')
#endregion parameters - get from config

#region Devbox SKU
capacity=$(echo $config | jq -r '.customer_stamp_config.devbox_sku.capacity')
family=$(echo $config | jq -r '.customer_stamp_config.devbox_sku.family')
compute=$(echo $config | jq -r '.customer_stamp_config.devbox_sku.compute')
size=$(echo $config | jq -r '.customer_stamp_config.devbox_sku.size')
tier=$(echo $config | jq -r '.customer_stamp_config.devbox_sku.tier')
osstoragetype=$(echo $config | jq -r '.customer_stamp_config.devbox_sku.osstoragetype')
#endregion Devbox SKU

#region Set the variables
RESOURCE_GROUP="${resource_name_primary_prefix}-${resource_name_secondary_prefix}-${resource_name_customer_short}-${customer_OEM_suffix}-${environment_stage_short}-rg-001"
DEV_CENTER_NAME="${resource_name_primary_prefix}-${resource_name_secondary_prefix}-${resource_name_customer_short}-${customer_OEM_suffix}-${environment_stage_short}-dc"
PROJECT="${resource_name_primary_prefix}-${resource_name_secondary_prefix}-${resource_name_customer_short}-${customer_OEM_suffix}-p-${project_name}-001"
DEVBOX_DEF_NAME="${resource_name_primary_prefix}-${resource_name_secondary_prefix}-${resource_name_customer_short}-${customer_OEM_suffix}-${project_name}-devboxdef"
VNET_NAME="${resource_name_primary_prefix}-${resource_name_secondary_prefix}-${resource_name_customer_short}-${customer_OEM_suffix}-${environment_stage_short}-vnet-001"
DEV_CENTER_NETWORK_CONNECTION_NAME="${resource_name_primary_prefix}-${resource_name_secondary_prefix}-${resource_name_customer_short}-${customer_OEM_suffix}-${project_name}-ntwkcon-001"
DEV_CENTER_ATTACHED_NETWORK_CONNECTION_NAME="${resource_name_primary_prefix}-${resource_name_secondary_prefix}-${resource_name_customer_short}-${customer_OEM_suffix}-${project_name}-ntwk-001"
NETWORK_CONNECTION_RG_NAME="${resource_name_primary_prefix}-${resource_name_secondary_prefix}-${resource_name_customer_short}-${customer_OEM_suffix}-${environment_stage_short}-${project_name}-rg-ntcon-001"
DEV_CENTER_POOL_NAME="${resource_name_primary_prefix}-${resource_name_secondary_prefix}-${resource_name_customer_short}-${customer_OEM_suffix}-${project_name}-pools-001"
#endregion Set the variables

#region Install Azure Dev Center extension
echo "Installing the Azure Dev Center extension"
clear_command_variables
command="az extension add --name devcenter --upgrade"
execute_command_exit_on_failure "$command" _command_output _command_status
echo "Extension installation complete!"
#endregion Install Azure Dev Center extension

#region Create Dev Box definition
echo "Creating Dev Box definition"
clear_command_variables
command="az devcenter admin devbox-definition create \
    --dev-center $DEV_CENTER_NAME \
    --devbox-definition-name $DEVBOX_DEF_NAME \
    --image-reference \"{\\\"id\\\": \\\"/subscriptions/$subscription_id/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.DevCenter/devcenters/$DEV_CENTER_NAME/galleries/default/images/$IMAGE\\\"}\" \
    --os-storage-type $osstoragetype \
    --resource-group $RESOURCE_GROUP \
	--sku \"{\\\"capacity\\\": $capacity, \\\"family\\\": \\\"$family\\\", \\\"name\\\": \\\"$compute\\\", \\\"size\\\": \\\"$size\\\", \\\"tier\\\": \\\"$tier\\\"}\" \
    --hibernate-support \"Enabled\" \
    --location \"$LOCATION\""
execute_command_exit_on_failure "$command" _command_output _command_status
echo "Dev Box definition created successfully."
#endregion Create Dev Box definition

#region Get OEM subnet ID
echo "Getting OEM subnet ID"
clear_command_variables
command="az network vnet subnet show --name $OEM_Subnet --vnet-name $VNET_NAME --resource-group $RESOURCE_GROUP --query id --output tsv"
commandGetSubnetId_output=""
execute_command_exit_on_failure "$command" commandGetSubnetId_output _command_status
echo "Got OEM subnet ID: $commandGetSubnetId_output"
#endregion Get OEM subnet ID

#region Create Azure Dev Center Network Connection
echo "Creating Azure Dev Center Network Connection"
clear_command_variables
command="az devcenter admin network-connection create \
    --domain-join-type \"AzureADJoin\" \
    --name \"$DEV_CENTER_NETWORK_CONNECTION_NAME\" \
    --resource-group $RESOURCE_GROUP \
    --subnet-id \"$commandGetSubnetId_output\" \
    --location \"$LOCATION\" \
    --networking-resource-group-name \"$NETWORK_CONNECTION_RG_NAME\""
execute_command_exit_on_failure "$command" _command_output _command_status
echo "Azure Dev Center Network Connection created successfully."
#endregion Create Azure Dev Center Network Connection

#region Get Network Connection ID
echo "Getting Network Connection ID"
clear_command_variables
commandGetNetworkConnectionId_output=""
command="az devcenter admin network-connection show --name \"$DEV_CENTER_NETWORK_CONNECTION_NAME\" --resource-group "$RESOURCE_GROUP" --query id --output tsv"
execute_command_exit_on_failure "$command" commandGetNetworkConnectionId_output _command_status
echo "Got Network Connection ID is $commandGetNetworkConnectionId_output"
#endregion Get Network Connection ID

#region Create Dev Center Attached Network
echo "Creating Azure Dev Center attached network"
clear_command_variables
command="az devcenter admin attached-network create \
    --attached-network-connection-name \"$DEV_CENTER_ATTACHED_NETWORK_CONNECTION_NAME\" \ 
    --network-connection-id \"/subscriptions/$subscription_id/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.DevCenter/networkConnections/$DEV_CENTER_NETWORK_CONNECTION_NAME\" \
    --resource-group $RESOURCE_GROUP \
    --dev-center $DEV_CENTER_NAME"
execute_command_exit_on_failure "$command" _command_output _command_status
echo "Created Azure Dev Center Attached network successfully."
#endregion Create Dev Center Attached Network

#region Create Dev center pool
echo "Creating Azure Dev Center pool"
clear_command_variables
command="az devcenter admin pool create \
    --devbox-definition-name \"$DEVBOX_DEF_NAME\" \
    --local-administrator \"Enabled\" \
    --name \"$DEV_CENTER_POOL_NAME\" \
    --project \"$PROJECT\" \
    --resource-group \"$RESOURCE_GROUP\" \
    --location \"$LOCATION\" \
    --network-connection-name \"$DEV_CENTER_ATTACHED_NETWORK_CONNECTION_NAME\""
execute_command_exit_on_failure "$command" _command_output _command_status
echo "Azure Dev Center Pool created successfully."
#endregion Create Dev center pool

echo_output_dictionary_to_output_file
